// Função para escapar texto (evita XSS se os dados vierem de fora)
function escapeHtml(str) {
  if (str == null) return "-";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

const formatDate = (date) => {
  if (!date) return "-"; // cobre null, undefined, "", 0, false
  const d = new Date(date);
  if (Number.isNaN(d.getTime())) return "-"; // data inválida
  // Retorna formato dd/mm/aaaa (pt-BR). Remova timeZone se quiser hora local.
  return d.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
}

async function fetchDados() {
  try {
    const response = await fetch('https://pool-api-alpha.vercel.app/api/v1/pool/');
    if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
    const dados = await response.json();

    const lista = document.getElementById('dados-lista');
    if (!lista) {
      console.warn("Elemento com id 'dados-lista' não encontrado no DOM.");
      return;
    }

    const items = Array.isArray(dados?.data) ? dados.data : [];
    if (items.length === 0) {
      lista.innerHTML = '<tr><td colspan="5">Sem dados</td></tr>';
      return;
    }

    const html = items.map(item => {
      return `<tr>
        <td>${escapeHtml(item.pool_id ?? "-")}</td>
        <td>${escapeHtml(item.nome ?? "-")}</td>
        <td>${escapeHtml(item.ph ?? "-")}</td>
        <td>${escapeHtml(item.cloro ?? "-")}</td>
        <td>${escapeHtml(formatDate(item.date))}</td>
      </tr>`;
    }).join('');

    lista.innerHTML = html;

  } catch (error) {
    console.error('Erro ao buscar dados:', error);
    // opcional: mostrar mensagem no HTML
    const lista = document.getElementById('dados-lista');
    if (lista) lista.innerHTML = '<tr><td colspan="5">Erro ao carregar dados</td></tr>';
  }
}

document.addEventListener('DOMContentLoaded', fetchDados);
